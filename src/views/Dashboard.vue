<template>
	<div id="welcome2-widget">
		<span v-if="loading" class="icon icon-loading" />
		<NcRichText v-else-if="content"
			class="markdown-content"
			:text="content"
			:use-markdown="true" />
		<NcEmptyContent v-else
			:description="emptyContentMessage">
			<template #icon>
				<CloseIcon />
			</template>
		</NcEmptyContent>
		<a v-if="supportUserId"
			v-tooltip.top="{ content: callSupportUserTooltip }"
			class="call-link"
			:href="callUrl">
			<NcAvatar :user="supportUserId"
				:tooltip-message="supportUserName" />
			<span>{{ callSupportUserText }}</span>
		</a>
	</div>
</template>

<script>
import CloseIcon from 'vue-material-design-icons/Close.vue'

import axios from '@nextcloud/axios'
import { generateUrl } from '@nextcloud/router'

import NcAvatar from '@nextcloud/vue/dist/Components/NcAvatar.js'
import NcEmptyContent from '@nextcloud/vue/dist/Components/NcEmptyContent.js'
import Tooltip from '@nextcloud/vue/dist/Directives/Tooltip.js'

import { NcRichText } from '@nextcloud/vue/dist/Components/NcRichText.js'

import Vue from 'vue'
Vue.directive('tooltip', Tooltip)

export default {
	name: 'Dashboard',

	components: {
		NcEmptyContent,
		NcAvatar,
		NcRichText,
		CloseIcon,
	},

	props: {
		title: {
			type: String,
			required: true,
		},
	},

	data() {
		return {
			loading: true,
			content: '',
			userId: null,
			userName: null,
			supportUserId: null,
		}
	},

	computed: {
		emptyContentMessage() {
			return t('welcome2', 'No welcome2 content')
		},
		callUrl() {
			return generateUrl('/apps/spreed/?callUser=' + this.supportUserId)
		},
		callSupportUserText() {
			return this.supportText
				? this.supportText.replace('{name}', this.supportUserName)
				: t('welcome2', 'Talk to your support contact ({name})', { name: this.supportUserName })
		},
		callSupportUserTooltip() {
			return t('welcome2', 'Talk to {name}', { name: this.supportUserName })
		},
	},

	beforeMount() {
		this.getContent()
	},

	mounted() {
	},

	methods: {
		getContent() {
			const url = generateUrl('/apps/welcome2/widget-content')
			axios.get(url).then((response) => {
				this.content = response.data.content
				// eslint-disable-next-line
				this.content = this.content.replaceAll(/\!\[(.*)\]\(.*\?fileId=(\d+).*/g, (match, p1, p2) => {
					// we get the image we an app-specific endpoint
					return '![' + p1 + '](' + generateUrl('/apps/welcome2/widget/image/{fileId}', { fileId: p2 }) + ')'
				})
				this.userId = response.data.userId
				this.userName = response.data.userName
				this.supportUserId = response.data.supportUserId
				this.supportUserName = response.data.supportUserName
				this.supportText = response.data.supportText
			}).catch((error) => {
				console.error(error)
			}).then(() => {
				this.loading = false
			})
		},
	},
}
</script>

<style scoped lang="scss">
:deep(.markdown-content) {
	h1, h2, h3, h4, h5 {
		font-weight: bold;
		margin: 12px 0 12px 0;
	}
	h1 {
		font-size: 30px;
		line-height: 30px;
	}
	h2 {
		font-size: 20px;
		line-height: 20px;
	}
	h3 {
		font-size: 16px;
		line-height: 20px;
	}
	h4 {
		font-size: 14px;
		line-height: 20px;
	}
	h5 {
		font-size: 12px;
		line-height: 20px;
	}
	ul, ol {
		list-style-type: none;
		li {
			list-style-type: none;
		}
		li:before {
			content: '•';
			padding-right: 8px;
		}
		ul, ol {
			margin-left: 20px;
			li:before {
				content: '∘';
			}
			ul, ol {
				li:before {
					content: '⁃';
				}
			}
		}
	}
	a {
		color: var(--color-text-light);
		text-decoration: underline;
	}
	p {
		> img {
			display: block;
			margin: 0 auto 0 auto;
			max-height: 150px;
			max-width: 250px;
		}
	}
}

#welcome2-widget {
	overflow: scroll;
	height: 100%;
	padding: 0 10px 0 10px;

	.icon-loading {
		display: block;
		margin-top: 50%;
	}

	.call-link {
		display: flex;
		margin-top: 25px;
		border-radius: var(--border-radius-large);
		padding: 8px 0;
		span {
			margin: auto 0 auto 10px;
		}
		&:hover {
			background-color: var(--color-background-hover);
		}
	}
}
</style>
